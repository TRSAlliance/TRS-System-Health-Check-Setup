#!/bin/bash

# TRS Workflow Quick Fix Script
# Fixes common workflow issues and updates deprecated actions

echo "ðŸ”§ TRS Workflow Quick Fix Starting..."

# Create backup of current workflows
echo "ðŸ“ Creating backup of existing workflows..."
mkdir -p .workflow-backup
if [ -d ".github/workflows" ]; then
  cp -r .github/workflows/* .workflow-backup/ 2>/dev/null || echo "No workflows to backup"
fi

# Fix deprecated actions in all workflow files
echo "ðŸ”„ Fixing deprecated GitHub Actions..."

find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
  if [ -f "$file" ]; then
    echo "Fixing: $file"
    
    # Create temporary file
    temp_file=$(mktemp)
    
    # Fix deprecated actions
    sed -e 's/actions\/checkout@v3/actions\/checkout@v4/g' \
        -e 's/actions\/setup-node@v3/actions\/setup-node@v4/g' \
        -e 's/actions\/upload-artifact@v3/actions\/upload-artifact@v4/g' \
        -e 's/actions\/download-artifact@v3/actions\/download-artifact@v4/g' \
        -e 's/actions\/github-script@v6/actions\/github-script@v7/g' \
        -e 's/actions\/cache@v3/actions\/cache@v4/g' \
        "$file" > "$temp_file"
    
    # Replace original file
    mv "$temp_file" "$file"
    
    echo "âœ… Fixed: $file"
  fi
done

# Check for and fix common workflow syntax issues
echo "ðŸ” Checking for workflow syntax issues..."

find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
  if [ -f "$file" ]; then
    # Check if workflow has required structure
    if ! grep -q "^on:" "$file"; then
      echo "âš ï¸  Warning: $file missing 'on:' trigger"
    fi
    
    if ! grep -q "^jobs:" "$file"; then
      echo "âš ï¸  Warning: $file missing 'jobs:' section"
    fi
    
    # Check for common YAML syntax errors
    if grep -q $'\t' "$file"; then
      echo "ðŸ”§ Fixing tabs to spaces in: $file"
      sed -i 's/\t/  /g' "$file"
    fi
  fi
done

# Create or update package.json with health check script
echo "ðŸ“¦ Setting up package.json scripts..."

if [ ! -f "package.json" ]; then
  echo "Creating basic package.json..."
  cat > package.json << 'EOF'
{
  "name": "trs-system",
  "version": "1.0.0",
  "description": "TRS System Health Check",
  "scripts": {
    "health": "node scripts/health-check.js",
    "health:watch": "nodemon scripts/health-check.js",
    "health:ci": "node scripts/health-check.js --json",
    "fix:workflows": "./scripts/workflow-fix.sh"
  },
  "devDependencies": {
    "nodemon": "^3.0.0"
  }
}
EOF
else
  # Add health check scripts if they don't exist
  if command -v jq >/dev/null 2>&1; then
    jq '.scripts.health = "node scripts/health-check.js" | 
        .scripts["health:watch"] = "nodemon scripts/health-check.js" | 
        .scripts["health:ci"] = "node scripts/health-check.js --json"' package.json > package.tmp && mv package.tmp package.json
    echo "âœ… Updated package.json with health check scripts"
  else
    echo "âš ï¸  jq not found. Please manually add health check scripts to package.json"
  fi
fi

# Ensure scripts directory exists
mkdir -p scripts

# Set up health check script if it doesn't exist
if [ ! -f "scripts/health-check.js" ] && [ -f "Script" ]; then
  echo "ðŸ“‹ Copying health check script..."
  cp Script scripts/health-check.js
  chmod +x scripts/health-check.js
fi

# Create or update .gitignore
echo "ðŸ“ Updating .gitignore..."
cat >> .gitignore << 'EOF'

# Health check reports
health-check-*.json
*.log

# Backup files
.workflow-backup/

# Node modules
node_modules/

# Environment files
.env
.env.local
.env.production
EOF

# Test workflow syntax (if GitHub CLI is available)
if command -v gh >/dev/null 2>&1; then
  echo "ðŸ§ª Testing workflow syntax with GitHub CLI..."
  find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
    echo "Testing: $file"
    # Note: This would require GitHub CLI workflow validation if available
  done
else
  echo "â„¹ï¸  GitHub CLI not available for workflow validation"
fi

# Create a simple workflow status check
echo "ðŸ“Š Creating workflow status summary..."
cat > .workflow-status.md << 'EOF'
# TRS Workflow Status

## Fixed Issues:
- âœ… Updated deprecated GitHub Actions to v4
- âœ… Fixed tab/space formatting issues
- âœ… Added missing workflow structure checks
- âœ… Created health check automation

## Next Steps:
1. Commit these changes
2. Push to trigger workflows
3. Monitor workflow runs in GitHub Actions tab
4. Run health check: `npm run health`

## Manual Verification:
```bash
# Test locally first
npm run health

# Check workflow syntax (if you have act installed)
act --list

# Push changes
git add .
git commit -m "fix: update deprecated GitHub Actions and workflow structure"
git push
```
EOF

echo "âœ… TRS Workflow Fix Complete!"
echo ""
echo "ðŸ“‹ Summary:"
echo "   - Fixed deprecated GitHub Actions (v3 â†’ v4)"
echo "   - Updated workflow structure"  
echo "   - Set up health check scripts"
echo "   - Created backup in .workflow-backup/"
echo ""
echo "ðŸš€ Next Steps:"
echo "   1. Review changes: cat .workflow-status.md"
echo "   2. Test locally: npm run health"
echo "   3. Commit and push changes"
echo "   4. Monitor GitHub Actions tab"
